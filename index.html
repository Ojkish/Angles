<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur d'Angles - Corrigé</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-color: #111;
            --accent-color: #f1c40f;
            --danger-color: #e74c3c;
            --text-color: #eee;
        }

        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            flex-direction: row; 
            overflow: hidden; 
        }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100% !important; border-right: none !important; order: 2; padding: 10px !important; }
            .view { height: 45vh; order: 1; flex-shrink: 0; }
            .results-container { order: 0; width: 100%; }
        }

        .sidebar { 
            width: 300px; 
            background: var(--panel-color); 
            padding: 12px; 
            border-right: 1px solid #333; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            box-sizing: border-box;
        }

        .results-container { display: flex; flex-direction: column; }
        .view { flex-grow: 1; background: #000; position: relative; min-height: 250px; }
        canvas { width: 100%; height: 100%; display: block; }

        .input-group { 
            background: #1a1a1a; 
            padding: 8px 12px; 
            border-radius: 8px; 
            border: 1px solid #222; 
        }

        label { 
            display: block; 
            font-size: 0.7em; 
            color: #888; 
            margin-bottom: 4px; 
            text-transform: uppercase; 
            font-weight: bold; 
            letter-spacing: 0.5px; 
        }
        
        .flex-input { display: flex; gap: 10px; align-items: center; }
        input[type="range"] { flex-grow: 1; accent-color: var(--accent-color); cursor: pointer; }
        input[type="number"] { 
            width: 50px; 
            background: #222; 
            border: 1px solid #444; 
            color: #fff; 
            padding: 4px; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 0.9em;
        }

        .results { 
            background: var(--accent-color); 
            color: #000; 
            padding: 15px; 
            border-radius: 8px;
            font-weight: 800; 
            margin-bottom: 5px;
        }
        
        .results.infinite { background: var(--danger-color); color: #fff; }
        .results p { margin: 5px 0; display: flex; justify-content: space-between; font-size: 1em; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 2px; }
        .results span { font-family: monospace; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="results-container" id="topResults">
    <div id="resPanel" class="results">
        <p>Largeur au sol : <span id="resDiam">--</span></p>
        <p>Décalage (d) : <span id="resDecal">--</span></p>
    </div>
</div>

<div class="sidebar">
    <div id="sidebarTarget"></div>
    <div class="input-group">
        <label>Ouverture α (°)</label>
        <div class="flex-input">
            <input type="range" id="alphaRange" min="2" max="120" value="40">
            <input type="number" id="alphaNum" value="40">
        </div>
    </div>
    <div class="input-group">
        <label>Hauteur h (m)</label>
        <div class="flex-input">
            <input type="range" id="hRange" min="1" max="20" step="0.1" value="7">
            <input type="number" id="hNum" value="7">
        </div>
    </div>
    <div class="input-group">
        <label>Inclinaison (Tilt °)</label>
        <div class="flex-input">
            <input type="range" id="tiltRange" min="-80" max="80" value="0">
            <input type="number" id="tiltNum" value="0">
        </div>
    </div>
</div>

<div class="view">
    <canvas id="canvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resPanel = document.getElementById('resPanel');
    const sidebarTarget = document.getElementById('sidebarTarget');
    const topResults = document.getElementById('topResults');

    const ui = {
        alpha: document.getElementById('alphaNum'),
        h: document.getElementById('hNum'),
        tilt: document.getElementById('tiltNum')
    };

    function adjustLayout() {
        if (window.innerWidth <= 768) {
            if (resPanel.parentElement !== topResults) topResults.appendChild(resPanel);
        } else {
            if (resPanel.parentElement !== sidebarTarget) sidebarTarget.appendChild(resPanel);
        }
        update();
    }

    document.querySelectorAll('input').forEach(input => {
        input.oninput = (e) => {
            const id = e.target.id.replace('Range', '').replace('Num', '');
            document.getElementById(id+'Range').value = e.target.value;
            document.getElementById(id+'Num').value = e.target.value;
            update();
        };
    });

    window.onresize = adjustLayout;

    function update() {
        const a = parseFloat(ui.alpha.value), h = parseFloat(ui.h.value), t = parseFloat(ui.tilt.value);
        const aRad = a * Math.PI / 180, tRad = t * Math.PI / 180;

        // Calcul des angles limites par rapport à l'axe h
        const angleGauche = tRad - aRad/2;
        const angleDroit = tRad + aRad/2;

        let x1, x2;
        let isInfinite = (angleGauche <= -Math.PI / 2 || angleDroit >= Math.PI / 2);
        
        // Coordonnées sur l'axe vertical du sol
        x1 = (angleGauche <= -Math.PI / 2) ? 5000 : -h * Math.tan(angleGauche);
        x2 = (angleDroit >= Math.PI / 2) ? -5000 : -h * Math.tan(angleDroit);

        document.getElementById('resDiam').innerText = isInfinite ? "∞" : Math.abs(x2 - x1).toFixed(2) + "m";
        document.getElementById('resDecal').innerText = (angleGauche <= -Math.PI / 2) ? "∞" : (-x1).toFixed(2) + "m";

        if (isInfinite) resPanel.classList.add('infinite');
        else resPanel.classList.remove('infinite');

        draw(h, tRad, x1, x2, isInfinite);
    }   

    function draw(h, tRad, x1, x2, isInfinite) {
        canvas.width = canvas.clientWidth; 
        canvas.height = canvas.clientHeight;
        
        const scale = Math.min(canvas.width / (h + 5), canvas.height / 20);
        const startX = 60; 
        const centerY = canvas.height / 2;
        const groundX = startX + (h * scale);

        ctx.clearRect(0,0, canvas.width, canvas.height);

        // SOL
        ctx.strokeStyle = "#444"; ctx.lineWidth = 1;
        ctx.setLineDash([]);
        ctx.beginPath(); ctx.moveTo(groundX, 0); ctx.lineTo(groundX, canvas.height); ctx.stroke();

        // AXE POINTILLÉ (h)
        ctx.strokeStyle = "rgba(255, 255, 255, 0.2)";
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(startX, centerY);
        ctx.lineTo(groundX, centerY);
        ctx.stroke();
        ctx.setLineDash([]);

        // FAISCEAU
        ctx.fillStyle = isInfinite ? "rgba(231, 76, 60, 0.45)" : "rgba(241, 196, 15, 0.35)";
        ctx.beginPath();
        ctx.moveTo(startX, centerY); 
        // On utilise l'angle géométrique standard (Y vers le haut = négatif en canvas)
        ctx.lineTo(groundX, centerY + (x1 * scale)); 
        ctx.lineTo(groundX, centerY + (x2 * scale)); 
        ctx.closePath();
        ctx.fill();

        // PROJECTEUR
        ctx.save();
        ctx.translate(startX, centerY);
        // On aligne la rotation du projecteur sur celle du faisceau
        // Le -tRad compense l'inversion de l'axe Y du canvas
        ctx.rotate(-tRad); 
        
        // Corps vers la gauche
        ctx.fillStyle = "#333";
        ctx.fillRect(-35, -12, 35, 24); 
        
        // Lentille jaune vers la droite (faisceau)
        ctx.fillStyle = isInfinite ? "#e74c3c" : "#f1c40f";
        ctx.fillRect(-2, -12, 4, 24); 
        ctx.restore();

        // TEXTE HAUTEUR
        ctx.fillStyle = "#888";
        ctx.font = "bold 13px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("h = " + h + "m", (startX + groundX) / 2, centerY - 15);
    }

    adjustLayout();
</script>
</body>
</html>
