<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Angles — contrôle par décalage</title>
<style>
:root{
  --bg-color:#050505;
  --panel-color:#111;
  --accent-color:#f1c40f;
  --danger-color:#e74c3c;
  --text-color:#eee;
}
body{
  font-family:system-ui,-apple-system, sans-serif;
  background:var(--bg-color);
  color:var(--text-color);
  margin:0;
  display:flex;
  min-height:100dvh;
  flex-direction:column;
  overflow-x:hidden;
  overflow-y:auto;
}
@media (max-width:768px){
  body{flex-direction:column;overflow-y:auto;}
  .sidebar{width:100% !important;border-right:none !important;order:2;padding:10px !important;}
  .view{height:45vh;order:1;flex-shrink:0;}
  .results-container{order:0;width:100%;}
}
.sidebar{
  width:300px;
  background:var(--panel-color);
  padding:12px;
  border-right:1px solid #333;
  display:flex;
  flex-direction:column;
  gap:8px;
  box-sizing:border-box;
}
.results-container{display:flex;flex-direction:column;}
.view{flex-grow:1;background:#000;position:relative;min-height:250px;}
canvas{width:100%;height:100%;display:block;}
.input-group{
  background:#1a1a1a;padding:8px 12px;border-radius:8px;border:1px solid #222;
}
label{
  display:block;font-size:0.7em;color:#888;margin-bottom:4px;text-transform:uppercase;font-weight:bold;letter-spacing:0.5px;
}
.flex-input{display:flex;gap:10px;align-items:center;}
input[type="range"]{flex-grow:1;accent-color:var(--accent-color);cursor:pointer;}
input[type="number"]{
  width:70px;background:#222;border:1px solid #444;color:#fff;padding:4px;border-radius:4px;font-weight:bold;font-size:0.9em;
}
.results{
  background:var(--accent-color);color:#000;padding:15px;border-radius:8px;font-weight:800;margin-bottom:5px;
}
.results.infinite{background:var(--danger-color);color:#fff;}
.results p{margin:5px 0;display:flex;justify-content:space-between;font-size:1em;border-bottom:1px solid rgba(0,0,0,0.1);padding-bottom:2px;}
.results span{font-family:monospace;font-size:1.2em;}
.info-small{font-weight:600;color:#111;background:transparent;border-radius:4px;padding:2px 6px;}
</style>
</head>
<body>

<div class="results-container" id="topResults">
  <div id="resPanel" class="results">
    <p>Largeur au sol : <span id="resDiam">--</span></p>
    <p>Inclinaison (tilt) : <span id="resTilt">--</span></p>
  </div>
</div>

<div class="sidebar">
  <div id="sidebarTarget"></div>

  <div class="input-group">
    <label>Ouverture α (°)</label>
    <div class="flex-input">
      <input type="range" id="alphaRange" min="1" max="120" value="40">
      <input type="number" step="any" id="alphaNum" value="40">
    </div>
  </div>

  <div class="input-group">
    <label>Hauteur h (m)</label>
    <div class="flex-input">
      <input type="range" id="hRange" min="1" max="20" step="0.1" value="7">
      <input type="number" step="any" id="hNum" value="7">
    </div>
  </div>

  <div class="input-group">
    <label>Décalage (d) (m)</label>
    <div class="flex-input">
      <input type="range" id="decalRange" min="-30" max="30" step="0.01" value="0">
      <input type="number" step="any" id="decalNum" value="0">
    </div>
  </div>
</div>

<div class="view">
  <canvas id="canvas"></canvas>
</div>

<script>
/* === DOM references === */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const resPanel = document.getElementById('resPanel');
const topResults = document.getElementById('topResults');
const sidebarTarget = document.getElementById('sidebarTarget');

const alphaRange = document.getElementById('alphaRange');
const hRange = document.getElementById('hRange');
const decalRange = document.getElementById('decalRange');

const alphaNum = document.getElementById('alphaNum');
const hNum = document.getElementById('hNum');
const decalNum = document.getElementById('decalNum');

const resDiam = document.getElementById('resDiam');
const resTilt = document.getElementById('resTilt');

/* === last valid numeric values used for drawing (robust while typing) === */
const lastValid = {
  alpha: toNumberFromInputString(alphaNum.value) || 40,
  h: toNumberFromInputString(hNum.value) || 7,
  decal: toNumberFromInputString(decalNum.value) || 0
};

/* === responsive placement === */
function adjustLayout(){
  if (window.innerWidth <= 768){
    if (resPanel.parentElement !== topResults) topResults.appendChild(resPanel);
  } else {
    if (resPanel.parentElement !== sidebarTarget) sidebarTarget.appendChild(resPanel);
  }
  update();
}
window.addEventListener('resize', adjustLayout);

/* === helpers === */
function toNumberFromInputString(str){
  if (typeof str !== 'string' && typeof str !== 'number') return NaN;
  const s = (''+str).replace(',', '.').trim();
  const n = parseFloat(s);
  return isFinite(n) ? n : NaN;
}
function isWithinRange(val, rangeEl){
  const min = parseFloat(rangeEl.min);
  const max = parseFloat(rangeEl.max);
  if (isNaN(min) || isNaN(max)) return false;
  return val >= min && val <= max;
}

/* === Range -> Number sync (range enforces limits) === */
alphaRange.addEventListener('input', () => {
  alphaNum.value = alphaRange.value;
  lastValid.alpha = parseFloat(alphaRange.value);
  update();
});
hRange.addEventListener('input', () => {
  hNum.value = hRange.value;
  lastValid.h = parseFloat(hRange.value);
  update();
});
decalRange.addEventListener('input', () => {
  decalNum.value = decalRange.value;
  lastValid.decal = parseFloat(decalRange.value);
  update();
});

/* === Number inputs: accept any numeric value; only sync slider if value in slider's range === */
function bindNumberInput(numEl, rangeEl, keyName){
  numEl.addEventListener('input', (e) => {
    const raw = e.target.value;
    const n = toNumberFromInputString(raw);
    if (!isNaN(n)){
      lastValid[keyName] = n;
      if (rangeEl && isWithinRange(n, rangeEl)){
        rangeEl.value = n;
      }
    }
    update();
  });

  numEl.addEventListener('focus', function(){
    try { this.select(); } catch (err) {}
    setTimeout(()=>{ this.scrollIntoView({behavior:'smooth', block:'center'}); }, 300);
  });

  numEl.addEventListener('blur', (e) => {
    const raw = e.target.value;
    if (raw === '') return;
    const n = toNumberFromInputString(raw);
    if (!isNaN(n)){
      e.target.value = '' + n;
    }
  });
}

bindNumberInput(alphaNum, alphaRange, 'alpha');
bindNumberInput(hNum, hRange, 'h');
bindNumberInput(decalNum, decalRange, 'decal');

/* === Initial decal from defaults (keeps UI stable for old users) === */
(function initializeDecalFromDefaults(){
  const a0 = toNumberFromInputString(alphaNum.value) || lastValid.alpha;
  const h0 = toNumberFromInputString(hNum.value) || lastValid.h;
  const t0 = 0;
  const aRad0 = a0 * Math.PI / 180;
  const angleGauche0 = t0 * Math.PI / 180 - aRad0/2;
  const d0 = h0 * Math.tan(angleGauche0);
  lastValid.decal = isFinite(d0) ? d0 : 0;
  decalNum.value = '' + lastValid.decal;
  if (isWithinRange(lastValid.decal, decalRange)){
    decalRange.value = lastValid.decal;
  }
})();

/* === Core calculation & drawing ===
   User controls decal 'd'. From d, a and h we compute:
     angleGauche = atan2(d, h)
     angleDroit = angleGauche + aRad
     tilt tRad = angleGauche + aRad/2
*/
function update(){
  const a = Number(lastValid.alpha);
  const h = Number(lastValid.h);
  const d = Number(lastValid.decal);

  const aRad = (isFinite(a) ? a * Math.PI / 180 : 0);
  const hNumVal = (isFinite(h) ? h : 0);
  const dNumVal = (isFinite(d) ? d : 0);

  const angleGauche = Math.atan2(dNumVal, hNumVal);
  const angleDroit = angleGauche + aRad;
  const tRad = angleGauche + aRad/2;
  const tDeg = (tRad * 180 / Math.PI);

  const EPS = 1e-12;
  const isInfinite = (angleGauche <= -Math.PI/2 + EPS) || (angleDroit >= Math.PI/2 - EPS);

  const x1 = -dNumVal;
  let x2;
  if (angleDroit >= Math.PI/2 - EPS){
    x2 = -5000;
  } else {
    x2 = -hNumVal * Math.tan(angleDroit);
  }

  resDiam.innerText = isInfinite ? "∞" : Math.abs(x2 - x1).toFixed(2) + "m";
  resTilt.innerText = isFinite(tDeg) ? (tDeg.toFixed(2) + "°") : "NaN";

  if (isInfinite) resPanel.classList.add('infinite');
  else resPanel.classList.remove('infinite');

  draw(hNumVal, tRad, x1, x2, isInfinite);
}

/* === draw (unchanged visual behavior) === */
function draw(h, tRad, x1, x2, isInfinite){
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;

  const scale = Math.min(canvas.width / (Math.max(h, 0) + 5), canvas.height / 20);
  const startX = 60;
  const centerY = canvas.height / 2;
  const groundX = startX + (h * scale);

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle = "#444"; ctx.lineWidth = 1;
  ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(groundX,0); ctx.lineTo(groundX,canvas.height); ctx.stroke();

  ctx.strokeStyle = "rgba(255,255,255,0.2)";
  ctx.setLineDash([5,5]);
  ctx.beginPath(); ctx.moveTo(startX, centerY); ctx.lineTo(groundX, centerY); ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle = isInfinite ? "rgba(231,76,60,0.45)" : "rgba(241,196,15,0.35)";
  ctx.beginPath();
  ctx.moveTo(startX, centerY);
  ctx.lineTo(groundX, centerY + (x1 * scale));
  ctx.lineTo(groundX, centerY + (x2 * scale));
  ctx.closePath();
  ctx.fill();

  ctx.save();
  ctx.translate(startX, centerY);
  ctx.rotate(-tRad);
  ctx.fillStyle = "#333"; ctx.fillRect(-35, -12, 35, 24);
  ctx.fillStyle = isInfinite ? "#e74c3c" : "#f1c40f";
  ctx.fillRect(-2, -12, 4, 24);
  ctx.restore();

  ctx.fillStyle = "#888";
  ctx.font = "bold 13px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("h = " + h + "m", (startX + groundX)/2, centerY - 15);
}

/* === kickoff === */
adjustLayout();
</script>
</body>
</html>
